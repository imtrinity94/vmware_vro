<?xml version="1.0" encoding="UTF-8"?>
<workflow xmlns="http://vmware.com/vco/workflow" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://vmware.com/vco/workflow http://vmware.com/vco/workflow/Workflow-v4.xsd" root-name="item6" object-name="Workflow:name=generic" id="90808080808080808080808080808080D28080800120523434428525559a3425f" version="0.0.9" api-version="6.0.0" allowed-operations="vef" restartMode="1" resumeFromFailedMode="0">
  <display-name><![CDATA[Run SSH command]]></display-name>
  <description><![CDATA[Runs an SSH command.]]></description>
  <position y="10.0" x="160.0"></position>
  <input>
    <param name="hostNameOrIP" type="string">
      <description><![CDATA[Hostname or IP address of the SSH host]]></description>
    </param>
    <param name="port" type="number">
      <description><![CDATA[Target port]]></description>
    </param>
    <param name="username" type="string">
      <description><![CDATA[Username]]></description>
    </param>
    <param name="password" type="SecureString">
      <description><![CDATA[Password]]></description>
    </param>
    <param name="cmd" type="string">
      <description><![CDATA[The SSH command to run]]></description>
    </param>
    <param name="passwordAuthentication" type="boolean">
      <description><![CDATA[Sets authentication to password or key file]]></description>
    </param>
    <param name="path" type="Path">
      <description><![CDATA[Path to the private key]]></description>
    </param>
    <param name="passphrase" type="SecureString">
      <description><![CDATA[Private key pass-phrase]]></description>
    </param>
    <param name="encoding" type="string">
      <description><![CDATA[The encoding to be used. Leave this field empty to use the default system encoding. (Example values: "UTF-8", "ISO-8859-1"...)]]></description>
    </param>
  </input>
  <output>
    <param name="result" type="number">
      <description><![CDATA[0 = OK, Negative = Error, Positive = Number of values returned, after error text]]></description>
    </param>
    <param name="errorText" type="string">
      <description><![CDATA[Error text, if any]]></description>
    </param>
    <param name="outputText" type="string">
      <description><![CDATA[Result of running the SSH command]]></description>
    </param>
  </output>
  <attrib name="output" type="string" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
    <description><![CDATA[Standard output]]></description>
  </attrib>
  <attrib name="error" type="string" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
    <description><![CDATA[Error output]]></description>
  </attrib>
  <attrib name="defaultKeyPairPath" type="Path" read-only="false">
    <value encoded="n"><![CDATA[/var/lib/vco/app-server/conf/vco_key]]></value>
    <description><![CDATA[Default path to the key file]]></description>
  </attrib>
  <attrib name="exitCode" type="string" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
    <description><![CDATA[Returns 0 if successful, and a negative value if there is a failure]]></description>
  </attrib>
  <attrib name="logText" type="string" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
    <description><![CDATA[Log String]]></description>
  </attrib>
  <workflow-item name="item3" out-name="item2" type="condition" alt-out-name="item4" comparator="0">
    <display-name><![CDATA[ok?]]></display-name>
    <script encoded="false"><![CDATA[//Generated by the system, cannot be edited
return (exitCode == "0") ;]]></script>
    <in-binding>
      <bind name="exitCode" type="string" export-name="exitCode"></bind>
    </in-binding>
    <condition name="exitCode" type="string" comparator="0" label="null">0</condition>
    <position y="170.0" x="120.0"></position>
  </workflow-item>
  <workflow-item name="item2" out-name="item5" content-mode="y" type="task">
    <display-name><![CDATA[System+Server log]]></display-name>
    <script encoded="false"><![CDATA[//Auto-generated script
System.log(text + " - " + object);
Server.log(text, object);
]]></script>
    <in-binding>
      <bind name="text" type="String" export-name="cmd">
        <description><![CDATA[The text to log]]></description>
      </bind>
      <bind name="object" type="string" export-name="logText">
        <description><![CDATA[The text to log and additional info]]></description>
      </bind>
    </in-binding>
    <out-binding></out-binding>
    <description><![CDATA[Log the input text to the console and the server log with level 'log']]></description>
    <position y="240.0" x="40.0"></position>
  </workflow-item>
  <workflow-item name="item4" out-name="item5" content-mode="y" type="task">
    <display-name><![CDATA[System+Server error]]></display-name>
    <script encoded="false"><![CDATA[//Auto-generated script
System.error(text + " - " + object);
Server.error(text, object);
]]></script>
    <in-binding>
      <bind name="text" type="String" export-name="cmd">
        <description><![CDATA[The text to log]]></description>
      </bind>
      <bind name="object" type="string" export-name="logText">
        <description><![CDATA[The text to log and additional info]]></description>
      </bind>
    </in-binding>
    <out-binding></out-binding>
    <description><![CDATA[Log the input text to the console and the server log with level 'error']]></description>
    <position y="240.0" x="200.0"></position>
  </workflow-item>
  <workflow-item name="item5" out-name="item8" type="task">
    <display-name><![CDATA[Assign]]></display-name>
    <script encoded="false"><![CDATA[outputText = output;
errorText = error;
if(exitCode == "0"){
	result = 1;
} else {
	result = -1;
	throw "SSH execute command failed. Reason: " + error;
}
]]></script>
    <in-binding>
      <bind name="output" type="string" export-name="output"></bind>
      <bind name="error" type="string" export-name="error"></bind>
      <bind name="exitCode" type="string" export-name="exitCode">
        <description><![CDATA[Returns 0 if successful, and a negative value if there is a failure]]></description>
      </bind>
    </in-binding>
    <out-binding>
      <bind name="result" type="number" export-name="result"></bind>
      <bind name="outputText" type="string" export-name="outputText"></bind>
      <bind name="errorText" type="string" export-name="errorText"></bind>
    </out-binding>
    <position y="280.0" x="120.0"></position>
  </workflow-item>
  <workflow-item name="item6" out-name="item9" type="task">
    <display-name><![CDATA[Execute SSH Command]]></display-name>
    <script encoded="false"><![CDATA[var session = null;
try {
	if (port) {
		session = new SSHSession(hostName, username, port);
	} else {
		System.log("A port value is not provided! Using default port 22");
		session = new SSHSession(hostName, username);
	}

	if (passwordAuthentication){
		System.log("Connecting with password");
	} else {
		if (path == null || path == ""){
			System.log("using default");
			path = defaultKeyPairPath;
		}
		System.log("Connecting with key pair (" + path + ")");
		password = passphrase;
	}

	session.connectWithPasswordOrIdentity(passwordAuthentication, password, path);
	System.log("Connected!");

	System.log("Executing '" + cmd + "' using encoding '" + (encoding ? encoding : "Default System Encoding") + "'");
	session.setEncoding(encoding);
	session.executeCommand(cmd, true);

	output = session.getOutput();
	error = session.getError();
	exitCode = session.exitCode;

	System.log("Output: '" + output + "'");
	System.log("Error: '" + error + "'");
	System.log("Exit code: '" + exitCode + "'");

} catch (e) {
	throw "Unable to execute command: " + e;
} finally {
	if (session) {
		session.disconnect();
	}
}
]]></script>
    <in-binding>
      <bind name="username" type="string" export-name="username"></bind>
      <bind name="password" type="SecureString" export-name="password"></bind>
      <bind name="cmd" type="string" export-name="cmd"></bind>
      <bind name="passwordAuthentication" type="boolean" export-name="passwordAuthentication"></bind>
      <bind name="path" type="Path" export-name="path"></bind>
      <bind name="hostName" type="string" export-name="hostNameOrIP"></bind>
      <bind name="passphrase" type="SecureString" export-name="passphrase"></bind>
      <bind name="defaultKeyPairPath" type="Path" export-name="defaultKeyPairPath"></bind>
      <bind name="encoding" type="string" export-name="encoding"></bind>
      <bind name="port" type="number" export-name="port">
        <description><![CDATA[Port]]></description>
      </bind>
    </in-binding>
    <out-binding>
      <bind name="output" type="string" export-name="output"></bind>
      <bind name="error" type="string" export-name="error"></bind>
      <bind name="exitCode" type="string" export-name="exitCode"></bind>
    </out-binding>
    <position y="60.0" x="120.0"></position>
  </workflow-item>
  <workflow-item name="item8" type="end" end-mode="0">
    <position y="310.0" x="160.0"></position>
  </workflow-item>
  <workflow-item name="item9" out-name="item3" type="task">
    <display-name><![CDATA[Prepare for log]]></display-name>
    <script encoded="false"><![CDATA[logText = "output: " + output + "\n" + "error: " + error;
]]></script>
    <in-binding>
      <bind name="output" type="string" export-name="output"></bind>
      <bind name="error" type="string" export-name="error"></bind>
    </in-binding>
    <out-binding>
      <bind name="logText" type="string" export-name="logText"></bind>
    </out-binding>
    <position y="120.0" x="120.0"></position>
  </workflow-item>
  <presentation>
    <p-step>
      <title><![CDATA[Host]]></title>
      <p-group>
        <title><![CDATA[Host selection]]></title>
        <desc><![CDATA[Select if you want ot choose host from a list or enter a name or IP address]]></desc>
        <p-param name="hostNameOrIP">
          <desc><![CDATA[Host name or IP  of the SSH host]]></desc>
          <p-qual kind="static" name="mandatory" type="boolean"><![CDATA[true]]></p-qual>
        </p-param>
        <p-param name="port">
          <desc><![CDATA[Port]]></desc>
          <p-qual kind="static" name="defaultValue" type="number"><![CDATA[22]]></p-qual>
          <p-qual kind="static" name="maxNumberValue" type="Number"><![CDATA[65535.0]]></p-qual>
          <p-qual kind="static" name="minNumberValue" type="Number"><![CDATA[0.0]]></p-qual>
        </p-param>
      </p-group>
      <p-group>
        <title><![CDATA[Command]]></title>
        <desc><![CDATA[The command to execute]]></desc>
        <p-param name="cmd">
          <desc><![CDATA[The SSH command to run]]></desc>
          <p-qual name="defaultValue" type="string"><![CDATA[uptime]]></p-qual>
        </p-param>
      </p-group>
      <p-group>
        <title><![CDATA[Encoding]]></title>
        <p-param name="encoding">
          <desc><![CDATA[The encoding to be used. Leave this field empty to use the default system encoding. (Example values: "UTF-8", "ISO-8859-1"...)]]></desc>
          <p-qual kind="static" name="defaultValue" type="string"><![CDATA[]]></p-qual>
        </p-param>
      </p-group>
      <p-group>
        <title><![CDATA[Authentication]]></title>
        <p-param name="username">
          <desc><![CDATA[Username]]></desc>
        </p-param>
        <p-param name="passwordAuthentication">
          <desc><![CDATA[Do you want to use password authentication? If you click No, key file authentication will be used.]]></desc>
        </p-param>
      </p-group>
    </p-step>
    <p-step>
      <title><![CDATA[Authentication]]></title>
      <p-group>
        <title><![CDATA[Password Authentication]]></title>
        <desc><![CDATA[Enter credentials info for host to execute the command on]]></desc>
        <p-qual kind="ognl" name="visible" type="boolean"><![CDATA[#passwordAuthentication]]></p-qual>
        <p-param name="password">
          <desc><![CDATA[Password]]></desc>
          <p-qual name="visible"><![CDATA[passwordAuthentication/passwordAuthentication]]></p-qual>
        </p-param>
      </p-group>
      <p-group>
        <title><![CDATA[Key File Authentication]]></title>
        <desc><![CDATA[If authentication method is password enter the password, otherwise enter the path for the key pair and passphrase for the private key]]></desc>
        <p-qual kind="ognl" name="notVisible" type="boolean"><![CDATA[#passwordAuthentication]]></p-qual>
        <p-param name="path">
          <desc><![CDATA[Path to private key]]></desc>
          <p-qual name="notVisible"><![CDATA[passwordAuthentication/passwordAuthentication]]></p-qual>
          <p-qual kind="ognl" name="defaultValue" type="Path"><![CDATA[#defaultKeyPairPath]]></p-qual>
        </p-param>
        <p-param name="passphrase">
          <desc><![CDATA[Private key pass-phrase]]></desc>
          <p-qual name="notVisible"><![CDATA[passwordAuthentication/passwordAuthentication]]></p-qual>
        </p-param>
      </p-group>
    </p-step>
  </presentation>
</workflow>